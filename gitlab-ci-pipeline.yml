variables:
  TUXPKG: tuxpkg

image: $CI_REGISTRY_IMAGE:ci-debian

ci-image-debian:
  stage: .pre
  image: docker:20.10-dind
  services:
  - name: docker:20.10-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
  - 'docker build --build-arg=EXTRA_PACKAGES="dpkg-dev apt-utils createrepo-c rpm gpg gpg-agent python3" -t $CI_REGISTRY_IMAGE:ci-debian -f Dockerfile.ci-debian .'
  - 'docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY'
  - 'docker push $CI_REGISTRY_IMAGE:ci-debian'
  only:
    refs:
    - master
    - main
    changes:
    - Dockerfile.ci-debian
    - debian/control
    - debian/changelog

ci-image-fedora:
  stage: .pre
  image: docker:20.10-dind
  services:
  - name: docker:20.10-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
  - 'docker build -t $CI_REGISTRY_IMAGE:ci-fedora -f Dockerfile.ci-fedora .'
  - 'docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY'
  - 'docker push $CI_REGISTRY_IMAGE:ci-fedora'
  only:
    refs:
    - master
    - main
    changes:
    - Dockerfile.ci-fedora
    - '*.spec'

rpm:
  stage: build
  image: $CI_REGISTRY_IMAGE:ci-fedora
  variables:
    FLIT_NO_NETWORK: 1
  script:
    - make rpm
  artifacts:
    paths:
      - dist/*.rpm

deb:
  stage: build
  variables:
    FLIT_NO_NETWORK: 1
  script:
    - make deb
  artifacts:
    paths:
      - dist/*.deb

repository:
  only:
    - tags
  needs:
    - deb
    - rpm
  stage: deploy
  script:
    - ${TUXPKG} create-repository
  artifacts:
    paths:
      - dist/repo

pypi:
  only:
    - tags
  stage: deploy
  variables:
    FLIT_USERNAME: __token__
  script:
    - apt-get update
    - apt-get install -qy --no-install-recommends git flit
    - "echo I: FLIT_USERNAME: ${FLIT_USERNAME}"
    - 'if [ -n "${FLIT_PASSWORD}" ]; then echo "I: FLIT_PASSWORD is set!"; else echo "E: FLIT_PASSWORD is NOT SET!"; fi'
    - flit publish
